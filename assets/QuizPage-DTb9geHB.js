import{d as A,e as V}from"./QCheckbox-c71ie5Sn.js";import{Q as B,h as P}from"./QInput-0OK5OjYo.js";import{Q as z}from"./QBtn-I20VTzYT.js";import{u as W,G as M,C as Z,a as j,Q as N,_ as O,b as G}from"./CategorySelector-BaRjEVS6.js";import{Q as K}from"./_plugin-vue_export-helper-tRu62fUX.js";import{af as X,r as g,c as U,a0 as F,a1 as y,aa as n,ag as Y,a6 as C,a3 as d,a4 as o,ac as v,x as J,a2 as k,ab as $,ah as H,a5 as I,ai as ee}from"./index-BwSGB-g4.js";import"./format-ClS5xHc8.js";import"./render-DO7taugi.js";import"./QScrollObserver-qmwnvbtb.js";const te=1440*60*1e3;class se{BUFFER_SIZE=5;calculatePriorityScore(l,e){let r=0;Math.max(l.errorRec.lastTime,l.correctRec.lastTime)>=e-te&&(r-=1e6),r-=l.correctRec.consecutive*1e4;const w=(e-l.errorRec.lastTime)/(1e3*60*60);return r+=Math.min(w,5e3),r+=Math.random()*1e3,r}getNextQuizWord(l,e=[]){if(l.length<1)return;const r=Date.now(),t=l.map(u=>({word:u,score:this.calculatePriorityScore(u,r)}));if(t.sort((u,x)=>x.score-u.score),l.length<=this.BUFFER_SIZE){if(l.length===1)return l[0];const u=e[e.length-1];console.log(t);const x=t.filter(i=>i.word.id!==u);return x.length>0?this.selectTopWordFromScoredList(x):this.selectTopWordFromScoredList(t)}const w=new Set(e.slice(-this.BUFFER_SIZE)),_=t.filter(u=>!w.has(u.word.id));return _.length>0?this.selectTopWordFromScoredList(_):this.selectTopWordFromScoredList(t)}selectTopWordFromScoredList(l){const e=l[0]?.score;if(e===void 0)return;const r=l.filter(f=>f.score===e),t=Math.floor(Math.random()*r.length);return r[t]?.word}}const oe=X("quizStore",()=>{const m=g(Z),l=W("quiz-selected-categories",[]),e=W("quiz-last-word-ids",[]),r=i=>{e.value.push(i),e.value.length>10&&e.value.shift()},t=W("words",M(new Set(l.value))),f=()=>{t.value=M(new Set(l.value))},w=i=>{l.value=i,f()},_=i=>{const a=t.value.find(b=>b.id===i);a&&(a.correctRec.count+=1,a.correctRec.consecutive+=1,a.correctRec.lastTime=Date.now(),a.errorRec.consecutive=0)},u=i=>{const a=t.value.find(b=>b.id===i);a&&(a.errorRec.count+=1,a.errorRec.lastTime=Date.now(),a.errorRec.consecutive+=1,a.correctRec.consecutive=0)},x=U(()=>{const a=t.value.slice().map(c=>({consecutiveCorrect:c.correctRec.consecutive,consecutiveError:c.errorRec.consecutive})),b=t.value.length,E=a.filter(({consecutiveError:c})=>c===1).length,S=a.filter(({consecutiveError:c})=>c===2).length,T=a.filter(({consecutiveError:c})=>c>=3).length,h=a.filter(({consecutiveCorrect:c})=>c===1).length,q=a.filter(({consecutiveCorrect:c})=>c===2).length,Q=a.filter(({consecutiveCorrect:c})=>c>=3).length;return{count:b,e1:E,e2:S,e3:T,c1:h,c2:q,c3:Q}});return{words:t,categoryOptions:m,selectedCategories:l,setCategories:w,resetQuiz:f,recordCorrectAns:_,recordErrorAns:u,meta:x,lastWordIds:e,recordLastWord:r}}),L=F({__name:"BtnHint",setup(m){return(l,e)=>(n(),y(z,Y(l.$attrs,{color:"grey-4","text-color":"grey-8",size:"sm"}),null,16))}}),re={class:"q-pa-md full-width"},le={class:"row q-col-gutter-sm justify-center"},ae={class:"col-6 col-md-auto text-center"},ne={class:"text-body1 text-weight-medium"},ce={class:"col-6 col-md-auto text-center"},ie={class:"text-body1 text-negative text-weight-medium"},ue={class:"col-6 col-md-auto text-center"},de={class:"text-body1 text-negative text-weight-medium"},ve={class:"col-6 col-md-auto text-center"},me={class:"text-body1 text-negative text-weight-medium"},ge={class:"col-6 col-md-auto text-center"},fe={class:"text-body1 text-positive text-weight-medium"},xe={class:"col-6 col-md-auto text-center"},he={class:"text-body1 text-positive text-weight-medium"},pe={class:"col-6 col-md-auto text-center"},ye={class:"text-body1 text-positive text-weight-medium"},we=F({__name:"InfoStrip",props:{meta:{}},setup(m){return(l,e)=>(n(),C("div",re,[d(A,{inset:"",class:"q-my-md"}),e[7]||(e[7]=o("div",{class:"text-subtitle1 q-mb-sm text-grey-8 text-center"},"測驗進度",-1)),o("div",le,[o("div",ae,[e[0]||(e[0]=o("div",{class:"text-caption text-grey-7"},"總單字數",-1)),o("div",ne,v(m.meta.count),1)]),d(A,{vertical:"",spaced:"",inset:"",class:"gt-sm"}),o("div",ce,[e[1]||(e[1]=o("div",{class:"text-caption text-grey-7"},"連答錯 1 次",-1)),o("div",ie,v(m.meta.e1),1)]),o("div",ue,[e[2]||(e[2]=o("div",{class:"text-caption text-grey-7"},"連答錯 2 次",-1)),o("div",de,v(m.meta.e2),1)]),o("div",ve,[e[3]||(e[3]=o("div",{class:"text-caption text-grey-7"},"連答錯 3+ 次",-1)),o("div",me,v(m.meta.e3),1)]),d(A,{vertical:"",spaced:"",inset:"",class:"gt-sm"}),o("div",ge,[e[4]||(e[4]=o("div",{class:"text-caption text-grey-7"},"連答對 1 次",-1)),o("div",fe,v(m.meta.c1),1)]),o("div",xe,[e[5]||(e[5]=o("div",{class:"text-caption text-grey-7"},"連答對 2 次",-1)),o("div",he,v(m.meta.c2),1)]),o("div",pe,[e[6]||(e[6]=o("div",{class:"text-caption text-grey-7"},"連答對 3 次",-1)),o("div",ye,v(m.meta.c3),1)])])]))}}),_e={class:"col flex flex-center full-width q-pa-md"},Se={key:0,class:"text-caption text-grey-6 text-center q-mb-sm"},Ce={class:"text-h5 text-weight-bold text-center"},be={key:1,class:"row justify-center text-subtitle1 text-grey-6 q-gutter-x-sm q-my-sm"},ke={key:0},qe={key:2},Qe={key:4},Re={key:2,class:"q-my-md text-center"},$e={key:1},ze={class:"text-subtitle1 text-red-8"},Ee={class:"text-weight-bold q-ml-xs"},Ne=F({__name:"QuizPage",setup(m){const l=new se,e=g(""),r=oe(),t=g(void 0),f=g(!1),w=g(!1),_=g(!1),u=g(0),x=g(!1),i=g([]),a=()=>{i.value=[...r.selectedCategories],x.value=!0},b=()=>{r.setCategories(i.value),x.value=!1,S()},E=U(()=>{if(!t.value||!t.value.categories||t.value.categories.length===0)return"";const R=t.value.categories[0],s=r.categoryOptions.find(p=>p.id===R);if(!s)return"";if(s.parentId){const p=r.categoryOptions.find(D=>D.id===s.parentId);return p?`${p.name} > ${s.name}`:s.name}return s.name});J(()=>{r.words.length===0?a():S()});const S=()=>{h.value&&t.value&&(q.value&&r.recordCorrectAns(t.value.id),Q.value&&r.recordErrorAns(t.value.id),h.value=!1,q.value=!1,Q.value=!1),t.value=l.getNextQuizWord(r.words,r.lastWordIds),t.value&&r.recordLastWord(t.value.id),console.log("nextQuestion",t.value),e.value="",f.value=!1,w.value=!1,_.value=!1},T=()=>{r.resetQuiz(),S(),u.value=0},h=g(!1),q=g(!1),Q=g(!1),c=()=>{if(console.log("checkAnswer",e.value),!e.value.trim())return S();if(!t.value)return;const R=e.value.trim().toLowerCase()===t.value.english.toLowerCase();if(u.value++,_.value)return S();h.value=!0,q.value=R&&!f.value&&!w.value,Q.value=!R};return(R,s)=>(n(),y(K,{padding:"",class:"column no-wrap items-center"},{default:k(()=>[o("div",_e,[x.value?(n(),y(V,{key:0,flat:"",class:"q-pa-lg soft-shadow rounded-borders bg-white",style:{width:"100%","max-width":"600px"}},{default:k(()=>[d(j,{modelValue:i.value,"onUpdate:modelValue":s[0]||(s[0]=p=>i.value=p),categories:H(r).categoryOptions,"confirm-label":"開始測驗",onConfirm:b},{title:k(()=>[...s[7]||(s[7]=[I("選擇測驗類別",-1)])]),_:1},8,["modelValue","categories"])]),_:1})):(n(),y(V,{key:1,flat:"",class:"q-pa-lg soft-shadow rounded-borders bg-white",style:{width:"100%","max-width":"400px"}},{default:k(()=>[t.value?(n(),y(N,{key:0,class:"q-pa-none"},{default:k(()=>[E.value?(n(),C("div",Se,v(E.value),1)):$("",!0),o("div",Ce,v(t.value?.chinese||"取得題目失敗"),1),h.value?$("",!0):(n(),C("div",be,[w.value?(n(),C("span",ke," ( "+v(t.value.english.length)+" 字 ) ",1)):(n(),y(L,{key:1,label:"字數: 開",onClick:s[1]||(s[1]=p=>w.value=!0)})),f.value?(n(),C("span",qe," [ "+v(t.value.english.charAt(0).toUpperCase())+"*** ] ",1)):(n(),y(L,{key:3,label:"首字: 開",onClick:s[2]||(s[2]=p=>f.value=!0)})),_.value||h.value?(n(),C("span",Qe,[I(" [ "+v(t.value.english)+" ] ",1),d(O,{word:t.value.english},null,8,["word"])])):(n(),y(L,{key:5,label:"答案",onClick:s[3]||(s[3]=p=>_.value=!0)}))])),h.value?(n(),C("div",Re,[q.value?(n(),y(B,{key:0,color:"green","text-color":"white",icon:"check_circle",label:"答案正確！",class:"q-pa-sm"})):Q.value?(n(),C("div",$e,[d(B,{color:"red","text-color":"white",icon:"cancel",label:"答案錯誤",class:"q-pa-sm q-mb-sm"}),o("div",ze,[s[8]||(s[8]=I(" 正確答案為： ",-1)),o("span",Ee,v(t.value.english),1),d(O,{word:t.value.english},null,8,["word"])])])):$("",!0)])):$("",!0),d(P,{modelValue:e.value,"onUpdate:modelValue":s[4]||(s[4]=p=>e.value=p),placeholder:"請輸入答案",onKeyup:s[5]||(s[5]=ee(()=>h.value?S():c(),["enter"])),class:"q-mb-sm"},null,8,["modelValue"]),d(z,{label:_.value||!e.value||h.value?"下一題":"檢查答案",onClick:s[6]||(s[6]=()=>h.value?S():c()),class:"full-width q-mb-md",unelevated:"",rounded:"",color:"primary",size:"lg"},null,8,["label"])]),_:1})):(n(),y(N,{key:1,class:"text-center q-pa-lg"},{default:k(()=>[s[9]||(s[9]=o("div",{class:"text-h6 text-grey-7"},"沒有題目",-1)),s[10]||(s[10]=o("div",{class:"text-caption text-grey-6 q-mt-sm"},"請嘗試選擇其他類別",-1)),d(z,{unelevated:"",rounded:"",color:"primary",label:"選擇類別",onClick:a,class:"q-mt-md"})]),_:1})),d(G,{align:"center"},{default:k(()=>[d(z,{flat:"",color:"grey-7",label:"重新開始",onClick:T,size:"md",icon:"refresh"}),d(z,{flat:"",color:"primary",label:"選擇類別",onClick:a,size:"md",icon:"category"})]),_:1})]),_:1}))]),x.value?$("",!0):(n(),y(we,{key:0,meta:H(r).meta,class:"col-auto"},null,8,["meta"]))]),_:1}))}});export{Ne as default};
